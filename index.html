<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบรายการยาโรงพยาบาล</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Using a nice Google Font for Thai language */
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
        body {
            font-family: 'Sarabun', sans-serif;
        }
        .sticky-header th { position: sticky; top: 0; z-index: 10; }
        .modal { transition: opacity 0.25s ease; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- =================================================================== -->
    <!-- 1. Public Page (หน้าสำหรับผู้ใช้ทั่วไป)                           -->
    <!-- =================================================================== -->
    <div id="public-page">
        <div class="container mx-auto p-4 sm:p-6 md:p-8">
            <header class="text-center mb-6">
                <h1 class="text-3xl sm:text-4xl font-bold text-blue-600">รายการยาในโรงพยาบาล</h1>
                <p class="text-gray-500 mt-2">ค้นหารายการยาและตรวจสอบจำนวนสูงสุดที่สามารถสั่งได้</p>
            </header>

            <div class="flex justify-between items-center mb-6">
                <input type="text" id="publicSearchInput" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ค้นหาด้วยชื่อสามัญ, ชื่อการค้า, หรือรหัสยา...">
                <button id="goToLoginBtn" class="ml-4 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-lg whitespace-nowrap">สำหรับเจ้าหน้าที่</button>
            </div>

            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-200 sticky-header">
                            <tr>
                                <th class="p-4 font-bold text-gray-600">รหัสยา</th>
                                <th class="p-4 font-bold text-gray-600">ชื่อสามัญ</th>
                                <th class="p-4 font-bold text-gray-600">ชื่อการค้า</th>
                                <th class="p-4 font-bold text-gray-600">รูปแบบยา</th>
                                <th class="p-4 font-bold text-gray-600 text-center">จำนวนสูงสุด</th>
                            </tr>
                        </thead>
                        <tbody id="publicTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- =================================================================== -->
    <!-- 2. Login Page (หน้าล็อกอิน)                                       -->
    <!-- =================================================================== -->
    <div id="login-page" class="hidden">
        <div class="min-h-screen flex items-center justify-center">
            <div class="w-full max-w-sm p-8 space-y-6 bg-white rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold text-center text-gray-800">เข้าสู่ระบบผู้ดูแล</h2>
                <div>
                    <label for="passwordInput" class="text-sm font-medium text-gray-700">รหัสผ่าน</label>
                    <input type="password" id="passwordInput" class="w-full px-3 py-2 mt-1 text-gray-700 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="••••••••">
                    <p id="passwordError" class="text-red-500 text-sm mt-1 h-4"></p>
                </div>
                <div class="flex gap-4">
                    <button id="cancelLoginBtn" class="w-full px-4 py-2 text-base font-medium text-gray-800 bg-gray-200 rounded-md shadow-sm hover:bg-gray-300">กลับหน้าหลัก</button>
                    <button id="submitPasswordBtn" class="w-full px-4 py-2 text-base font-medium text-white bg-blue-600 rounded-md shadow-sm hover:bg-blue-700">เข้าสู่ระบบ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- =================================================================== -->
    <!-- 3. Admin Dashboard Page (หน้าแดชบอร์ดผู้ดูแล)                     -->
    <!-- =================================================================== -->
    <div id="admin-page" class="hidden">
        <div class="container mx-auto p-4 sm:p-6 md:p-8">
            <header class="flex flex-wrap justify-between items-center mb-6 gap-4">
                <div>
                    <h1 class="text-3xl sm:text-4xl font-bold text-green-600">แดชบอร์ดผู้ดูแลระบบ</h1>
                    <p class="text-gray-500 mt-2">จัดการข้อมูลยา (เพิ่ม, ลบ, แก้ไข)</p>
                </div>
                <div class="flex gap-2">
                    <button id="changePasswordBtn" class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white font-bold rounded-lg">เปลี่ยนรหัสผ่าน</button>
                    <button id="logoutBtn" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-bold rounded-lg">ออกจากระบบ</button>
                </div>
            </header>

            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                <input type="text" id="adminSearchInput" class="w-full sm:w-2/3 p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="ค้นหาข้อมูลยา...">
                <button id="addDrugBtn" class="w-full sm:w-auto bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-5 rounded-lg">เพิ่มยาใหม่</button>
            </div>

            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-200 sticky-header">
                            <tr>
                                <th class="p-4 font-bold text-gray-600">รหัสยา</th>
                                <th class="p-4 font-bold text-gray-600">ชื่อสามัญ</th>
                                <th class="p-4 font-bold text-gray-600">ชื่อการค้า</th>
                                <th class="p-4 font-bold text-gray-600">รูปแบบยา</th>
                                <th class="p-4 font-bold text-gray-600 text-center">จำนวนสูงสุด</th>
                                <th class="p-4 font-bold text-gray-600 text-center">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="adminTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Modal (ใช้ร่วมกัน) -->
    <div id="drugModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full flex items-center justify-center hidden">
      <div class="relative mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
          <h3 id="modalTitle" class="text-lg leading-6 font-medium text-gray-900"></h3>
          <form id="drugForm" class="mt-2 px-7 py-3">
              <input type="text" id="genericName" placeholder="ชื่อสามัญ" class="mb-3 mt-2 px-3 py-2 text-gray-700 bg-gray-100 rounded text-sm focus:outline-none w-full" required>
              <input type="text" id="tradeName" placeholder="ชื่อการค้า" class="mb-3 px-3 py-2 text-gray-700 bg-gray-100 rounded text-sm focus:outline-none w-full">
              
              <!-- *** UPDATED: Drug Form Dropdown *** -->
              <div class="mb-3">
                  <label for="formSelect" class="block text-sm font-medium text-gray-700 text-left mb-1">รูปแบบยา</label>
                  <select id="formSelect" class="w-full px-3 py-2 text-gray-700 bg-gray-100 rounded text-sm focus:outline-none" required></select>
              </div>
              <div id="newFormContainer" class="hidden mb-3">
                  <input type="text" id="newFormInput" placeholder="ระบุรูปแบบยาใหม่..." class="w-full px-3 py-2 text-gray-700 bg-gray-100 rounded text-sm focus:outline-none">
              </div>

              <input type="number" id="max" placeholder="จำนวนสูงสุดที่สั่งได้" class="mb-3 px-3 py-2 text-gray-700 bg-gray-100 rounded text-sm focus:outline-none w-full disabled:bg-gray-200" required>
              
              <div class="flex items-center justify-end mb-4 -mt-1">
                <label for="unlimitedCheckbox" class="text-sm text-gray-700 mr-2">ไม่จำกัด</label>
                <input type="checkbox" id="unlimitedCheckbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
              </div>

              <div class="items-center px-4 py-3"><button id="saveBtn" type="submit" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600">บันทึก</button></div>
          </form>
          <button id="closeDrugModalBtn" class="absolute top-0 right-0 mt-4 mr-4 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
          </button>
        </div>
      </div>
    </div>
    
    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full flex items-center justify-center hidden">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">เปลี่ยนรหัสผ่านผู้ดูแล</h3>
                <form id="changePasswordForm" class="space-y-4 mt-4 px-7 py-3">
                    <div>
                        <label for="oldPassword" class="block text-sm font-medium text-gray-700 text-left">รหัสผ่านเก่า</label>
                        <input type="password" id="oldPassword" class="w-full px-3 py-2 mt-1 text-gray-700 border rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
                    </div>
                    <div>
                        <label for="newPassword" class="block text-sm font-medium text-gray-700 text-left">รหัสผ่านใหม่</label>
                        <input type="password" id="newPassword" class="w-full px-3 py-2 mt-1 text-gray-700 border rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
                    </div>
                    <div>
                        <label for="confirmNewPassword" class="block text-sm font-medium text-gray-700 text-left">ยืนยันรหัสผ่านใหม่</label>
                        <input type="password" id="confirmNewPassword" class="w-full px-3 py-2 mt-1 text-gray-700 border rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button type="submit" class="w-full px-4 py-2 text-base font-medium text-white bg-yellow-500 rounded-md shadow-sm hover:bg-yellow-600">ยืนยันการเปลี่ยนรหัสผ่าน</button>
                    </div>
                </form>
                 <button id="closeChangePasswordModalBtn" class="absolute top-0 right-0 mt-4 mr-4 text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {

        let medicineData = [
            { id: '1001', generic: 'Paracetamol', trade: 'Tylenol', form: 'เม็ด (Tablet)', max: 200 },
            { id: '1002', generic: 'Ibuprofen', trade: 'Brufen', form: 'เม็ด (Tablet)', max: 150 },
            { id: '1003', generic: 'Amoxicillin', trade: 'Amoxil', form: 'แคปซูล (Capsule)', max: null },
            { id: '1004', generic: 'Salbutamol', trade: 'Ventolin', form: 'ยาพ่น (Inhaler)', max: 2 },
        ];
        let drugForms = [
            'เม็ด (Tablet)',
            'แคปซูล (Capsule)',
            'ยาพ่น (Inhaler)',
            'ยาน้ำ (Syrup)',
            'ยาฉีด (Injection)'
        ];
        let ADMIN_PASSWORD = 'admin1234';
        let currentEditId = null;

        // Page elements
        const publicPage = document.getElementById('public-page');
        const loginPage = document.getElementById('login-page');
        const adminPage = document.getElementById('admin-page');
        
        // Public page elements
        const publicTableBody = document.getElementById('publicTableBody');
        const publicSearchInput = document.getElementById('publicSearchInput');
        const goToLoginBtn = document.getElementById('goToLoginBtn');

        // Login page elements
        const passwordInput = document.getElementById('passwordInput');
        const passwordError = document.getElementById('passwordError');
        const cancelLoginBtn = document.getElementById('cancelLoginBtn');
        const submitPasswordBtn = document.getElementById('submitPasswordBtn');

        // Admin page elements
        const adminTableBody = document.getElementById('adminTableBody');
        const adminSearchInput = document.getElementById('adminSearchInput');
        const addDrugBtn = document.getElementById('addDrugBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const changePasswordBtn = document.getElementById('changePasswordBtn');

        // Drug Modal elements
        const drugModal = document.getElementById('drugModal');
        const modalTitle = document.getElementById('modalTitle');
        const drugForm = document.getElementById('drugForm');
        const closeDrugModalBtn = document.getElementById('closeDrugModalBtn');
        const maxInput = document.getElementById('max');
        const unlimitedCheckbox = document.getElementById('unlimitedCheckbox');
        const formSelect = document.getElementById('formSelect');
        const newFormContainer = document.getElementById('newFormContainer');
        const newFormInput = document.getElementById('newFormInput');

        // Change Password Modal elements
        const changePasswordModal = document.getElementById('changePasswordModal');
        const changePasswordForm = document.getElementById('changePasswordForm');
        const closeChangePasswordModalBtn = document.getElementById('closeChangePasswordModalBtn');
        const oldPasswordInput = document.getElementById('oldPassword');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmNewPasswordInput = document.getElementById('confirmNewPassword');

        // --- Page Navigation ---
        const showPage = (pageId) => {
            publicPage.classList.add('hidden');
            loginPage.classList.add('hidden');
            adminPage.classList.add('hidden');
            document.getElementById(pageId).classList.remove('hidden');
        };

        // --- Rendering Functions ---
        const renderPublicTable = () => {
            const searchTerm = publicSearchInput.value.toLowerCase().trim();
            const filteredData = medicineData.filter(med => 
                med.generic.toLowerCase().includes(searchTerm) ||
                med.trade.toLowerCase().includes(searchTerm) ||
                med.id.includes(searchTerm)
            );
            publicTableBody.innerHTML = '';
            filteredData.forEach((med) => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b';
                const maxDisplay = med.max === null
                    ? `<span class="text-green-600 font-bold">ไม่จำกัด</span>`
                    : `<span class="font-bold text-red-600">${Number(med.max).toLocaleString()}</span>`;
                row.innerHTML = `
                    <td class="p-4">${med.id}</td>
                    <td class="p-4 font-semibold">${med.generic}</td>
                    <td class="p-4">${med.trade}</td>
                    <td class="p-4">${med.form}</td>
                    <td class="p-4 text-center text-lg">${maxDisplay}</td>
                `;
                publicTableBody.appendChild(row);
            });
        };

        const renderAdminTable = () => {
            const searchTerm = adminSearchInput.value.toLowerCase().trim();
            const filteredData = medicineData.filter(med => 
                med.generic.toLowerCase().includes(searchTerm) ||
                med.trade.toLowerCase().includes(searchTerm) ||
                med.id.includes(searchTerm)
            );
            adminTableBody.innerHTML = '';
            filteredData.forEach((med) => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b';
                const maxDisplay = med.max === null
                    ? `<span class="text-green-600 font-bold">ไม่จำกัด</span>`
                    : `<span class="font-bold text-red-600">${Number(med.max).toLocaleString()}</span>`;
                row.innerHTML = `
                    <td class="p-4">${med.id}</td>
                    <td class="p-4 font-semibold">${med.generic}</td>
                    <td class="p-4">${med.trade}</td>
                    <td class="p-4">${med.form}</td>
                    <td class="p-4 text-center text-lg">${maxDisplay}</td>
                    <td class="p-4 text-center">
                        <button class="edit-btn bg-yellow-400 hover:bg-yellow-500 text-white text-sm py-1 px-2 rounded" data-id="${med.id}">แก้ไข</button>
                        <button class="delete-btn bg-red-500 hover:bg-red-600 text-white text-sm py-1 px-2 rounded ml-2" data-id="${med.id}">ลบ</button>
                    </td>
                `;
                adminTableBody.appendChild(row);
            });
        };
        
        const populateFormDropdown = () => {
            formSelect.innerHTML = ''; // Clear existing options
            drugForms.forEach(form => {
                const option = document.createElement('option');
                option.value = form;
                option.textContent = form;
                formSelect.appendChild(option);
            });
            const addNewOption = document.createElement('option');
            addNewOption.value = 'add_new';
            addNewOption.textContent = 'เพิ่มรูปแบบยาใหม่...';
            formSelect.appendChild(addNewOption);
        };

        // --- Modal Functions ---
        const showDrugModal = (mode, drugId = null) => {
            currentEditId = drugId;
            drugForm.reset();
            populateFormDropdown();
            newFormContainer.classList.add('hidden');
            newFormInput.required = false;
            modalTitle.textContent = mode === 'edit' ? 'แก้ไขรายการยา' : 'เพิ่มยาใหม่';
            maxInput.disabled = false;
            maxInput.required = true;
            unlimitedCheckbox.checked = false;
            if (mode === 'edit') {
                const drug = medicineData.find(d => d.id === drugId);
                if (drug) {
                    document.getElementById('genericName').value = drug.generic;
                    document.getElementById('tradeName').value = drug.trade;
                    
                    if (drugForms.includes(drug.form)) {
                        formSelect.value = drug.form;
                    } else {
                        const newOption = document.createElement('option');
                        newOption.value = drug.form;
                        newOption.textContent = drug.form;
                        formSelect.insertBefore(newOption, formSelect.querySelector('option[value="add_new"]'));
                        formSelect.value = drug.form;
                    }

                    if (drug.max === null) {
                        unlimitedCheckbox.checked = true;
                        maxInput.disabled = true;
                        maxInput.required = false;
                        maxInput.value = '';
                    } else {
                        maxInput.value = drug.max;
                    }
                }
            }
            drugModal.classList.remove('hidden');
        };
        const hideDrugModal = () => drugModal.classList.add('hidden');
        const hideChangePasswordModal = () => {
            changePasswordForm.reset();
            changePasswordModal.classList.add('hidden');
        };

        // --- Event Handlers ---
        const handleFormSubmit = (event) => {
            event.preventDefault();
            const generic = document.getElementById('genericName').value.trim();
            let formValue;
            if (formSelect.value === 'add_new') {
                formValue = newFormInput.value.trim();
                if (formValue && !drugForms.includes(formValue)) {
                    drugForms.push(formValue);
                }
            } else {
                formValue = formSelect.value;
            }

            const isUnlimited = unlimitedCheckbox.checked;
            const max = isUnlimited ? null : parseInt(maxInput.value, 10);
            
            if (!generic || !formValue || (!isUnlimited && isNaN(max))) {
                alert("กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน");
                return;
            }
            if (currentEditId) {
                const drugIndex = medicineData.findIndex(d => d.id === currentEditId);
                if (drugIndex > -1) medicineData[drugIndex] = { ...medicineData[drugIndex], generic, trade: document.getElementById('tradeName').value.trim(), form: formValue, max };
            } else {
                medicineData.push({ id: String(Date.now()), generic, trade: document.getElementById('tradeName').value.trim(), form: formValue, max });
            }
            hideDrugModal();
            renderAdminTable();
        };

        const handleAdminTableClick = (event) => {
            const target = event.target;
            const drugId = target.dataset.id;
            if (!drugId) return;

            if (target.classList.contains('delete-btn')) {
                if (confirm(`คุณแน่ใจหรือไม่ว่าต้องการลบยา ID: ${drugId}?`)) {
                    medicineData = medicineData.filter(d => d.id !== drugId);
                    renderAdminTable();
                }
            } else if (target.classList.contains('edit-btn')) {
                showDrugModal('edit', drugId);
            }
        };

        const handleChangePasswordSubmit = (event) => {
            event.preventDefault();
            const oldPass = oldPasswordInput.value;
            const newPass = newPasswordInput.value;
            const confirmPass = confirmNewPasswordInput.value;

            if (oldPass !== ADMIN_PASSWORD) {
                alert("รหัสผ่านเก่าไม่ถูกต้อง!");
                return;
            }
            if (!newPass || newPass !== confirmPass) {
                alert("รหัสผ่านใหม่และการยืนยันไม่ตรงกัน!");
                return;
            }
            if (newPass === oldPass) {
                alert("รหัสผ่านใหม่ต้องไม่ซ้ำกับรหัสผ่านเก่า!");
                return;
            }

            ADMIN_PASSWORD = newPass;
            alert("เปลี่ยนรหัสผ่านสำเร็จแล้ว!");
            hideChangePasswordModal();
        };

        // --- Event Listeners Setup ---
        // Navigation
        goToLoginBtn.addEventListener('click', () => showPage('login-page'));
        cancelLoginBtn.addEventListener('click', () => showPage('public-page'));
        logoutBtn.addEventListener('click', () => {
            renderPublicTable();
            showPage('public-page');
        });

        // Login
        submitPasswordBtn.addEventListener('click', () => {
            if (passwordInput.value === ADMIN_PASSWORD) {
                passwordInput.value = '';
                passwordError.textContent = '';
                renderAdminTable();
                showPage('admin-page');
            } else {
                passwordError.textContent = 'รหัสผ่านไม่ถูกต้อง!';
                passwordInput.select();
            }
        });
        passwordInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') submitPasswordBtn.click();
            passwordError.textContent = '';
        });

        // Search
        publicSearchInput.addEventListener('input', renderPublicTable);
        adminSearchInput.addEventListener('input', renderAdminTable);

        // Admin Actions
        addDrugBtn.addEventListener('click', () => showDrugModal('add'));
        adminTableBody.addEventListener('click', handleAdminTableClick);
        changePasswordBtn.addEventListener('click', () => {
            changePasswordModal.classList.remove('hidden');
        });
        
        // Modal Actions
        closeDrugModalBtn.addEventListener('click', hideDrugModal);
        drugForm.addEventListener('submit', handleFormSubmit);
        unlimitedCheckbox.addEventListener('change', () => {
            maxInput.disabled = unlimitedCheckbox.checked;
            maxInput.required = !unlimitedCheckbox.checked;
            if (unlimitedCheckbox.checked) maxInput.value = '';
        });
        formSelect.addEventListener('change', () => {
            if (formSelect.value === 'add_new') {
                newFormContainer.classList.remove('hidden');
                newFormInput.required = true;
            } else {
                newFormContainer.classList.add('hidden');
                newFormInput.required = false;
            }
        });
        closeChangePasswordModalBtn.addEventListener('click', hideChangePasswordModal);
        changePasswordForm.addEventListener('submit', handleChangePasswordSubmit);

        // --- Initial Load ---
        renderPublicTable();
        showPage('public-page');

    });
    </script>
</body>
</html>
